"use strict";angular.module("myApp",["ngRoute","angularSpinner","myApp.welcome","myApp.editor","myApp.fileBrowser"]).config(["$routeProvider",function(e){e.otherwise({redirectTo:"/welcome"})}]).config(["$locationProvider",function(e){e.hashPrefix("")}]).run(["$rootScope",function(e){e.version="0.18_git9"}]).factory("Notification",function(){return $.notifyDefaults({allow_dismiss:!0,placement:{from:"top",align:"center"},template:'       <div data-notify="container" class="col-xs-11 col-sm-6 alert alert-{0}" role="alert">      \t<button type="button" aria-hidden="true" class="close" data-notify="dismiss">Ã—</button>      \t<span data-notify="icon"></span>      \t<span data-notify="title">{1}</span>      \t<span data-notify="message">{2}</span>      \t<div class="progress" data-notify="progressbar">      \t\t<div class="progress-bar progress-bar-{0}" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%;"></div>      \t</div>      \t<a href="{3}" target="{4}" data-notify="url"></a>      </div>',z_index:1050}),{notify:function(e,t,o){var n={type:e="error"===e?"danger":e};"danger"===e&&(void 0===n.delay&&(n.delay=0),o=o||"fire"),o&&(n.icon="glyphicon glyphicon-"+o),$.notify(t,n)}}}).controller("AuthInfoDialogCtrl",["$scope","$uibModalInstance","url",function(e,t,o){e.username="",e.password="",e.url=o,e.ok=function(){t.close({username:e.username,password:e.password})},e.cancel=function(){t.dismiss()}}]).factory("DocumentTree",["$q","$uibModal","usSpinnerService","WebID","RDFEConfig",function(n,r,i,t,o){var a=[],c=[],s={};function u(){var e=[],t=$.jStorage.get("rdfe:recentDocuments");if(t)for(var o=0;o<t.length&&o<10;o++){var n,r=t[o];r&&((n=new RDFE.IO.File(r.url)).ioType=r.ioType,n.name=r.title||r.name,n.sparqlEndpoint=r.sparqlEndpoint,e.push(n))}return e}function l(){var e=[],t=$.jStorage.get("rdfe:recentLocations");if(t)for(var o=0;o<t.length&&o<10;o++){var n,r=t[o];r&&("webdav"===r.ioType?n=new RDFE.IO.WebDavFolder(r.url):"ldp"===r.ioType?n=new RDFE.IO.LDPFolder(r.url):"sparql"===r.ioType?((n=new RDFE.IO.Folder(r.url)).ioType=r.ioType,n.sparqlEndpoint=r.sparqlEndpoint):(n=new RDFE.IO.Folder(r.url),r.type&&(n.type=r.type),n.ioType=r.ioType),e.push(n))}return e}return{getLocations:function(){var e;return a.length?n.when(a):((a=l()).unshift(((e=new RDFE.IO.Folder).name=e.path="Recent Documents",e.ioType="recent",e.comment="Documents you recently opened",e.children=u(),e)),n(function(t,e){o.getConfig().then(function(e){e=e.options.storage||[];e.length?RDFE.Utils.resolveStorageLocations(e,function(e){$.merge(a,e),t(a)}):t(a)},function(){t(a)})}))},getStorages:function(){return c.length?n.when(c):n(function(r,e){t.getWebID().then(function(){return t.getProfile()}).then(function(e){for(var t=[],o=e.storage||[],n=0;n<o.length;n++)_.isEmpty(_.where(t,{uri:o[n].uri}))&&(t=t.concat(o[n]));t.length?RDFE.Utils.resolveStorageLocations(t,function(e){$.merge(c,e),r(c)}):r(c)})})},getAuthInfo:function(o,e){var t=s[o];return t||"/"===o[o.length-1]||(t=s[o.substring(0,o.lastIndexOf("/")+1)]),!1===e||!0!==e&&t?n.when(t):n(function(t,e){i.stop("editor-spinner"),r.open({templateUrl:"tmpl/authinfodlg.html",controller:"AuthInfoDialogCtrl",resolve:{url:function(){return o}}}).result.then(function(e){s[o]=e,t(e)},e)})},getRecentDocs:u,addRecentDoc:function(e,t){for(var o,n=!0,r=$.jStorage.get("rdfe:recentDocuments")||[],i=0;i<r.length;i++)if((o=r[i]).url===e&&o.ioType===t){n=!1,r.splice(i,1),r.unshift(o);break}n&&((o=new RDFE.IO.File(e)).ioType=t,r.unshift(o),10<r.length)&&r.splice(r.length-1,1),$.jStorage.set("rdfe:recentDocuments",r)},getRecentLocations:l,addRecentLocation:function(e){if("recent"!==e.ioType){for(var t,o=!0,n=$.jStorage.get("rdfe:recentLocations")||[],r=0;r<n.length;r++)if((t=n[r]).url===e.url&&t.ioType===e.ioType){o=!1,n.splice(r,1),n.unshift(t);break}o&&((t=new RDFE.IO.Folder(e.url)).type=e.type,t.ioType=e.ioType,t.sparqlEndpoint=e.sparqlEndpoint,n.unshift(t),10<n.length)&&n.splice(n.length-1,1),$.jStorage.set("rdfe:recentLocations",n)}},deleteRecentLocation:function(e,t){if("recent"!==t)for(var o=$.jStorage.get("rdfe:recentLocations")||[],n=0;n<o.length;n++)if(o[n].url===e&&o[n].ioType===t)return o.splice(n,1),void $.jStorage.set("rdfe:recentLocations",o)},selectRecentLocation:function(e,t){if("recent"!==t)for(var o,n=$.jStorage.get("rdfe:recentLocations")||[],r=0;r<n.length;r++)if((o=n[r]).url===e&&o.ioType===t)return n.splice(r,1),n.unshift(o),void $.jStorage.set("rdfe:recentLocations",n)}}}]).factory("RDFEConfig",["$q","Notification",function(e,n){var r=null;return{getConfig:function(){return r?e.when(r):e(function(t,e){var o=RDFE.Utils.uriParams(),o=o.config||"config.json";r=new RDFE.Config(o,function(e){t(e)},function(){n.notify("error","Failed to load Editor configuration")})})}}}]).factory("WebID",["$q","Notification",function(t,e){var c=null,s=null;return{getWebID:function(e){return(c=e||c)?t.when(c):t(function(o,e){var n;"chrome-extension:"==location.protocol?(n=null,chrome.management.getAll(function(e){for(var t=0;t<e.length;t++)if("opl_youid"===e[t].shortName){n=e[t].id;break}n&&chrome.runtime.sendMessage(n,{getWebId:!0},function(e){(c=e?JSON.parse(e.webid).id:c)&&o(c)})})):(window.addEventListener("message",function(e){var t;if(0===String(e.data).lastIndexOf("youid_rc:",0)){try{t=JSON.parse(e.data.substr(9))}catch(e){}t&&t.webid&&(c=t.webid,o(c))}},!1),window.postMessage('youid:{"getWebId": true}',"*"))})},getProfile:function(){return c?s?t.when(s):t(function(i,a){$.get(c).done(function(o){if(s)return i(s);new rdfstore.create(function(e,r){var t=c.split("#")[0];r.registerDefaultProfileNamespaces(),r.load("text/n3",o,{documentIRI:t},function(e,t){e&&a("Failed to load the profile contents."),r.execute("select ?uri ?name ?img ?nick where {?x foaf:primaryTopic ?uri . optional { ?uri foaf:name ?name . } . optional { ?uri foaf:nick ?nick . } . optional { ?uri foaf:img ?img . } . }",function(e,t){e&&a("Failed to load the profile contents.");var n={uri:c};0!==t.length&&(t[0].name&&(n.name=t[0].name.value),t[0].img&&(n.image=t[0].img.value),t[0].nick)&&(n.nick=t[0].nick.value),r.execute("select ?storage where { <"+c+"> <http://www.w3.org/ns/pim/space#storage> ?storage . }",function(e,t){e&&a("Failed to load the profile contents.");for(var o=0;o<t.length;o++)t[o].storage&&(n.storage=n.storage||[]).push({uri:t[o].storage.value});r.execute("select ?namedGraph ?sparqlEndpoint where { <"+c+"> <http://www.openlinksw.com/schemas/cert#hasDBStorage> ?namedGraph . ?namedGraph <http://rdfs.org/ns/void#sparqlEndpoint> ?sparqlEndpoint . }",function(e,t){e&&a("Failed to load the profile contents.");for(var o=0;o<t.length;o++)t[o].namedGraph&&t[o].sparqlEndpoint&&(n.storage=n.storage||[]).push({uri:t[o].namedGraph.value,sparqlEndpoint:t[o].sparqlEndpoint.value});i(s=n)})})})})})}).fail(function(e,t,o){a("Failed to load the profile contents.")})}):t.reject()}}}]).controller("AuthHeaderCtrl",["$rootScope","$scope","WebID",function(n,r,i){r.signIn=function(e){var t=this,o=$("#signinModal");o.modal(),o.find(".ok").off(),o.find(".ok").on("click",function(e){e.preventDefault(),o.modal("hide");e=o.find("#signinValue").val();e?i.getWebID(e).then(function(){return i.getProfile()}).then(function(e){r.profile=e,n.$broadcast("signIn")}):$(t).trigger("rdf-editor-error",{type:"rdf-editor-error",message:"Please set a WebID value!"})})},i.getWebID().then(function(){return i.getProfile()}).then(function(e){r.profile=e})}]),angular.module("myApp.welcome",["ngRoute"]).config(["$routeProvider",function(e){e.when("/welcome",{templateUrl:"views/welcome.html",controller:"WelcomeCtrl"})}]).config(["$locationProvider",function(e){e.hashPrefix("")}]).controller("WelcomeCtrl",[function(){}]),angular.module("myApp.editor",["ngRoute"]).config(["$routeProvider",function(e){e.when("/editor",{templateUrl:"views/editor.html",controller:"EditorCtrl",reloadOnSearch:!1})}]).config(["$locationProvider",function(e){e.hashPrefix("")}]).run(["$rootScope",function(e){e.eav2spo={statements:"triples",entities:"subjects",attributes:"predicates",values:"objects",triples:"triples",subjects:"subjects",predicates:"predicates",objects:"objects"},e.spo2eav={triples:"statements",subjects:"entities",predicates:"attributes",objects:"values",statements:"statements",entities:"entities",attributes:"attributes",values:"values"}}]).factory("RDFEditor",["$q","$rootScope","$location","$timeout","usSpinnerService","RDFEConfig","Notification","DocumentTree",function(e,s,u,l,o,n,r,i){function a(e){var t,o,n,r={"triple:subject":"statement:entity","triple:predicate":"statement:attribute","triple:object":"statement:value","spo:subject":"eav:attribute","spo:predicate":"eav:entity","spo:object":"eav:value","statement:entity":"triple:subject","statement:attribute":"triple:predicate","statement:value":"triple:object","eav:attribute":"spo:subject","eav:entity":"spo:predicate","eav:value":"spo:object"},i="",a=u.search();for(n in a)o=a[t=n],"view"===n?o=("EAV"===e?s.spo2eav:s.eav2spo)[o]:r[n]&&(t=r[n]),i+="&"+t+"="+o;return u.path()+"?"+i}return{getEditor:function(){return e(function(t,e){n.getConfig().then(function(e){new RDFE.Editor({config:e,documentTree:i},function(c){$(c).on("rdf-editor-success",function(e,t){r.notify("success",t.message),setTimeout(function(){s.$apply(function(){})})}).on("rdf-editor-error",function(e,t){r.notify("error",t.message),setTimeout(function(){s.$apply(function(){})})}).on("rdf-editor-spinner-start",function(e,t){"editor-spinner"===t&&(c.spinner++,o.spin(t)),"export-spinner"===t&&o.spin(t)}).on("rdf-editor-spinner-done",function(e,t){"editor-spinner"===t&&(0<c.spinner&&c.spinner--,0===c.spinner)&&o.stop("editor-spinner"),"export-spinner"===t&&o.stop(t)}).on("rdf-editor-page",function(e,t){var o,n=c.config.options.pageSettings,r=u.search(),i=(t.view&&r.view!==t.view&&(u.search("view",t.view),u.search("pageNo",null),u.search("sortName",null),u.search("sortOrder",null),n.pageNo=null,n.sortName=null,n.sortOrder=null),t.pageNo&&n.pageNo!==t.pageNo&&(u.search("pageNo",t.pageNo),n.pageNo=t.pageNo),t.pageSize&&n.pageSize!==t.pageSize&&(u.search("pageSize",t.pageSize),n.pageSize=t.pageSize),t.sortName&&n.sortName!==t.sortName&&(u.search("sortName",t.sortName),n.sortName=t.sortName),t.sortOrder&&n.sortOrder!==t.sortOrder&&(u.search("sortOrder",t.sortOrder),n.sortOrder=t.sortOrder),"");for(o in r=u.search())i+="&"+o+"="+encodeURIComponent(r[o]);var a=u.path()+"?"+i;l(function(){u.url(a)})}).on("rdf-editor-namingSchema",function(e,t){var o=t.uiMode,t=t.viewMode,n=a(o);s.uiMode=o,s.viewMode=("EAV"===o?s.spo2eav:s.eav2spo)[t],s.radioViewMode=s.viewMode,l(function(){u.url(n)})}),t(c)})})})},prepareUrl:a}}]).filter("namingSchemaLabel",function(){return function(e,t,o,n){if(t.editor)return t.editor.namingSchema()[e][!0===o?1:0]}}).filter("namingSchemaTitle",function(){return function(e,t){if(t.editor){var o=t.editor.namingSchema();switch(e){case"SPO":return"SPO"===o?"RDF Statement Graph Representation [Data]":"Entity Relationship Representation  [Data]";case"s":return"SPO"===o?"Items described by sentence Predicate & Object pairs in this document":"Items described by Attribute & Value pairs in this document";case"p":return"SPO"===o?"How Sentence Subjects and Objects are associated":"How Entities and their Attribute Values are associated";case"o":return"SPO"===o?"Objects & Data Types associated with a  Sentence Subject via its Predicate":"Values & Data Types associated with an Entity Attribute";default:return e}}}}).controller("EditorCtrl",["$rootScope","$scope","$routeParams","$location","$timeout","usSpinnerService","RDFEditor","DocumentTree","Notification",function(l,p,g,f,m,e,t,h,v){function w(e,t,o,n){h.getAuthInfo&&(r=function(e,t,o){h.getAuthInfo(e,!0).then(t,o)});var r,o=RDFE.IO.createIO(t,{sparqlEndpoint:o,gspEndpoint:$("#gspEndpoint").val(),ioTimeout:n,accept:e});return o.type=t,o.options.authFunction=r,o}function y(){var e,t,o=g["triple:subject"]||g["spo:subject"],n=g["triple:predicate"]||g["spo:predicate"],r=g["triple:object"]||g["spo:object"],i=g["statement:entity"]||g["eav:entity"],a=g["statement:attribute"]||g["eav:attribute"],c=g["statement:value"]||g["eav:value"],s=g.view,u=g.uiMode,o=(o?e="triples"===s||"statements"===s?s:"subjects":n?e="triples"===s||"statements"===s?s:"predicates":r?e="triples"===s||"statements"===s?s:"objects":(o||n||r)&&(e="triples"),i?e="triples"===s||"statements"===s?s:"entities":a?e="triples"===s||"statements"===s?s:"attributes":c?e="triples"===s||"statements"===s?s:"values":i||a||c?e="statements":s&&(e=s),u||(-1<["triples","subjects","predicates","objects"].indexOf(e)?u="SPO":-1<["statements","entities","attributes","values"].indexOf(e)&&(u="EAV"),u=(u=u||$.jStorage.get("rdfe:settings",{}).namingSchema)||p.editor.config.options.namingSchema),e=e||p.editor.config.defaultView||"statements",p.editor.config.options.pageSettings);g.pageNo&&(t=parseInt(g.pageNo),isNaN(t)||(o.pageNo=t)),g.pageSize&&(t=parseInt(g.pageSize),isNaN(t)||(o.pageSize=t)),g.sortName&&(o.sortName=g.sortName),g.sortOrder&&(o.sortOrder=g.sortOrder),p.editor.config.options.namingSchema=u,l.uiMode=u,l.viewMode=("EAV"===u?p.spo2eav:p.eav2spo)[e],l.radioViewMode=p.viewMode,p.editor.toggleView(p.viewMode,p.uiMode)}function b(){var e=g.newStatement,t=g["triple:subject"]||g["spo:subject"],o=g["triple:predicate"]||g["spo:predicate"],n=g["triple:object"]||g["spo:object"],r=g["statement:entity"]||g["eav:entity"],i=g["statement:attribute"]||g["eav:attribute"],a=g["statement:value"]||g["eav:value"],c=p.viewMode;!t&&!r||c&&"subjects"!==c&&"entities"!==c?!o&&!i||c&&"predicates"!==c&&"attributes"!==c?!n&&!a||c&&"objects"!==c&&"values"!==c?!(t||o||n||r||i||a||e)||c&&"statements"!==c&&"triples"!==c||p.editor.editTriple(t||r,o||i,n||a,e):p.editor.editObject(n||a,e):(o=p.editor.ontologyManager.uriDenormalize(o||i),p.editor.editPredicate(o,e)):(t=p.editor.ontologyManager.uriDenormalize(t||r),p.editor.editSubject(t,e))}function o(){function e(e,t){return e&&n.params.push(t),e}function t(e,t){return e&&n.paramValues.push(t),e}function c(e,t){return e&&n.paramValues.push(t),e}var o,n={params:[],paramValues:[],paramMixed:[]},s={uiMode:{defaultValue:function(){var e,t;for(t in g)if(g.hasOwnProperty(t)){var o=s[t];if(o){var n=o.paramReference;if(n&&"uiMode"===n){if("string"==typeof o.value){if(c(e&&e!==o.value,t))return;e=o.value}if("object"==typeof o.value)for(var r in o.value)for(var i=o.value[r],a=0;a<i.length;a++)if(g[t]===i[a]){if(c(e&&e!==r,t))return;e=r}}}}return e||"EAV"},value:["EAV","SPO"]},view:{paramReference:"uiMode",value:{EAV:["statements","entities","attributes","values"],SPO:["triples","subjects","predicates","objects"]}},"triple:subject":{paramReference:"uiMode",value:"SPO"},"spo:subject":{paramReference:"uiMode",value:"SPO"},"triple:predicate":{paramReference:"uiMode",value:"SPO"},"spo:predicate":{paramReference:"uiMode",value:"SPO"},"triple:object":{paramReference:"uiMode",value:"SPO"},"spo:object":{paramReference:"uiMode",value:"SPO"},"statement:entity":{paramReference:"uiMode",value:"EAV"},"eav:entity":{paramReference:"uiMode",value:"EAV"},"statement:attribute":{paramReference:"uiMode",value:"EAV"},"eav:attribute":{paramReference:"uiMode",value:"EAV"},"statement:value":{paramReference:"uiMode",value:"EAV"},"eav:value":{paramReference:"uiMode",value:"EAV"},pageNo:{},pageSize:{},sortName:{},sortOrder:{},uri:{},data:{},accept:["text/turtle","application/ld+json"],ioType:["http","ldp","dav","webdav","sparql"],ioTimeout:{},sparqlEndpoint:{},newDocument:["true","false"],saveDocument:["true","false"],newStatement:["true","false"],"error.msg":{}};for(o in g)if(g.hasOwnProperty(o)){var r=g[o],i=s[o];if(!e(void 0===i,o))if(i instanceof Array){for(var a=0;a<i.length&&r!==i[a];a++);t(a===i.length,o)}else if("object"==typeof i&&!$.isEmptyObject(i)){var u=i.paramReference;if(u){var l=g[u];if(!l&&!(l=s[u].defaultValue()))break;if("string"==typeof i.value)e(i.value!==l,o);else if("object"==typeof i.value){var d=i.value[l];if(d){for(a=0;a<d.length&&r!==d[a];a++);t(a===d.length,o)}}}}}if(n.params.length||n.paramValues.length||n.paramMixed.length){var p="Params validation errors:";if(n.params.length){p+=" <br/>&nbsp;&nbsp;Unsupported or mixed parameters: ";for(var f="",a=0;a<n.params.length;a++)p+=f+n.params[a],f=", "}if(n.paramValues.length){p+=" <br/>&nbsp;&nbsp;Bad values for parameters: ",f="";for(a=0;a<n.paramValues.length;a++)p+=f+"["+n.paramValues[a]+"="+g[n.paramValues[a]]+"]",f=", "}if(n.paramMixed.length){p+=" <br/>&nbsp;&nbsp;Mixed parameters: ",f="";for(a=0;a<n.paramMixed.length;a++)p+=f+n.paramMixed[a],f=", "}v.notify("error",p)}}function F(){var e=t.prepareUrl(p.uiMode);m(function(){f.url(e)})}function n(){var e,t,o,n,r,a=g.uri,i=g.data,c=g.accept,s=("turtle"===c?c="text/turtle":"jsonld"===c&&(c="application/ld+json"),g.ioType||"http"),u=g.ioTimeout||p.editor.config.options.ioTimeout,l=g.sparqlEndpoint,d=g.newDocument;p.doc=p.editor.doc,p.editor.render($("#contents")),"true"===g.saveDocument?(e=w(c,s,l,u),p.saveDocumentInternal(a,e),p.editor.updateView(),f.search("saveDocument",null),F()):"true"===d||"false"===d&&!a&&!i?p.doc.new(function(){y(),p.editor.saveSubject=null,p.editor.updateView(),m(function(){"false"!==d&&a&&(p.doc.url=a,p.doc.io=w(c,s,l,u))}),b()},function(){v.notity("error","Failed to clear Document for unknown reasons.")}):a||i?(t=$.jStorage.get("rdfe:savedDocument",null))?p.doc.store.clear(p.doc.graph,function(){p.doc.store.loadTurtle(t,p.doc.graph,p.doc.graph,null,function(e){e||(y(),p.editor.saveSubject=null,p.editor.updateView(),m(function(){p.doc.dirty=!0,"false"===d?p.doc.url=null:(p.doc.url=a,p.doc.io=w(c,s,l,u))}),b())})}):(p.doc.url=null,o=function(){if(a)try{var e,t=w(c,s,l,u),o=function(r,t){function i(e){y(),p.editor.updateView(),p.editor.toggleSpinner(!1),p.$apply(function(){e||p.newDocument(),e&&"false"!==d?(p.doc.url=a,p.doc.io=t):p.doc.url=null}),b(),p.editor.docChanged()}p.editor.toggleSpinner(!0),p.doc.load(r,t,function(){i(!0)},function(e,t,o,n){e=e&&e.message?e.httpCode+" - "+e.message:"Failed to load document";v.notify("error",e+": "+r),i(!1)})};h.getAuthInfo?(e=a,"sparql"===t.type&&t.options&&t.options.sparqlEndpoint&&(e=t.options.sparqlEndpoint),h.getAuthInfo(e,!1).then(function(e){e&&(t.options.username=e.username,t.options.password=e.password),o(a,t)})):o(a,t)}catch(e){v.notify("error",e)}},i?(n=function(e){y(),p.editor.updateView(),p.editor.docChanged(),v.notify("success","Successfully imported RDF data."),o()},r=function(e){v.notify("error","Failed to import RDF data. <br /> "+e.message),o()},p.doc.store.clear(p.doc.graph,function(){p.doc.import(i,n,r)})):p.doc.store.clear(p.doc.graph,function(){o()})):(y(),b()),g["error.msg"]&&v.notify("error",g["error.msg"]),$.jStorage.deleteKey("rdfe:savedDocument"),p.ontologyView||(p.ontologyView=new RDFE.OntologyView(p.editor),p.ontologyView.render($("#container-ontologies")),$("#ontology-add").click(function(e){e.stopPropagation(),p.ontologyView.add()})),p.$watch(function(e){return e.radioViewMode},function(e){var t;e&&(t=p.viewMode,p.viewMode=("EAV"===p.uiMode?p.spo2eav:p.eav2spo)[e],p.radioViewMode=p.eav2spo[p.radioViewMode],t!==p.viewMode)&&p.editor.toggleView(p.viewMode,p.uiMode)})}p.newDocument=function(){p.doc.new(function(){y(),p.editor.saveSubject=null,p.editor.updateView(),b(),f.search("uri",null),f.search("data",null),f.search("accept",null),f.search("ioType",null),f.search("ioTimeout",null),f.search("sparqlEndpoint",null),F()},function(){v.notity("error","Failed to clear Document for unknown reasons.")})},p.openDocument=function(){function t(){f.url("/browser")}p.doc.dirty?bootbox.confirm("Your document has unsaved changes. Do you really want to open another document?",function(e){e&&p.$apply(t)}):t()},p.saveDocumentInternal=function(r,i){if(!r)return p.saveDocumentAs();function e(e,t,o){function n(e,t){p.editor.toggleSpinner(!0),p.doc.save(e,t,function(){F(),p.editor.toggleSpinner(!1),v.notify("success","Successfully saved document to <code>"+e+"</code>")},function(e){F(),p.editor.toggleSpinner(!1),v.notify("error",e?e.message||e:"An unknown error occured")})}if("success"===t){if((!p.doc.url||p.doc.io&&p.doc.io!==i)&&e.length)return void bootbox.confirm("Target document exists. Do you really want to overwrite it?",function(e){e&&n(r,i)});if(p.doc.srcParams&&(p.doc.srcParams.length!==e.length||p.doc.srcParams.md5!==$.md5(e)))return void bootbox.confirm("Target document was updated after last open/save. Do you really want to overwrite it?",function(e){e&&n(r,i)})}n(r,i)}i.retrieve(r,{success:e,error:e})},p.saveDocument=function(){p.saveDocumentInternal(p.doc.url,p.doc.io)},p.saveDocumentAs=function(){f.url("/browser?mode=save")},p.downloadDocumentAs=function(){p.doc.store.graph(p.doc.graph,function(e,t){var o,n,t=t.toNTBeatify(p.doc.store.rdf.prefixes);o="document.ttl",t=t,(n=document.createElement("a")).setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(t)),n.setAttribute("download",o),document.createEvent?((t=document.createEvent("MouseEvents")).initEvent("click",!0,!0),n.dispatchEvent(t)):n.click()})},p.settings=function(){p.editor.settingsForm()},p.signDocument=function(){p.editor.signDocumentForm()},p.localInto=function(){p.editor.localForm()},p.remoteInto=function(){p.editor.remoteForm()},p.importInto=function(){p.editor.importForm()},p.exportInto=function(){p.editor.exportForm()},p.undo=function(){p.editor.undo()},p.redo=function(){p.editor.redo()},p.unsignDocument=function(){p.editor.unsignDocumentForm()},p.closeDocument=function(){function t(){f.url("/")}p.doc.dirty?bootbox.confirm("Your document has unsaved changes. Do you really want to close the document?",function(e){e&&p.$apply(t)}):t()},p.toggleOntologyView=function(){var e=$("#panel-ontologies").find(".panel-heading");e.find(".up").toggle(),e.find(".down").toggle(),$("#container-ontologies").toggle(),$("#ontology-add").toggle()},p.editor?n():t.getEditor().then(function(e){l.editor=e,o(),n()})}]),angular.module("myApp.fileBrowser",["ngRoute","ui.bootstrap"]).config(["$routeProvider",function(e){e.when("/browser",{templateUrl:"views/browser.html",controller:"FileBrowserCtrl"})}]).config(["$locationProvider",function(e){e.hashPrefix("")}]).filter("ioTypeLabel",function(){return function(e){switch(e){case"webdav":return"WebDAV Folder";case"ldp":return"LDP Location";case"sparql":return"SPARQL Endpoint";default:return e}}}).filter("httpStatusLabel",function(){return function(e){switch(e){case 0:return"Connection Refused";case 404:return"Not Found";case 401:return"Authorization Required";case 403:return"Access Denied";default:return e}}}).controller("FileBrowserCtrl",["$rootScope","$scope","$routeParams","$timeout","$location","usSpinnerService","DocumentTree","Notification",function(n,r,e,i,o,a,c,s){"save"===e.mode?(r.mode=e.mode,r.title="Save Your Document"):(r.mode="open",r.title="Open a Document"),r.getLocations=function(){c.getLocations().then(function(e){r.locations=e;var t=0;if(n.currentLocation)for(var o=0;o<r.locations.length;o++)if(r.locations[o].url===n.currentLocation.url){t=o;break}r.updateCurrentLocation(r.locations[t]),r.updateCurrentFolder(r.currentLocation),a.stop("location-spinner")})},r.getStorages=function(){c.getStorages().then(function(e){for(var t,o=[],n=0;n<e.length;n++){for(t=0;t<r.locations.length&&r.locations[t].url!==e[n].url;t++);t===r.locations.length&&o.push(e[n])}r.locations=r.locations.concat(o)})},r.setCurrentLocation=function(o){var e;r.resetUI(),o!==r.currentLocation&&(o.httpStatus?(c.getAuthInfo&&(e=function(e,t,o){c.getAuthInfo(e,!0).then(t,o)}),RDFE.IO.openUrl(o.url,{authFunction:e,checkForFiles:!0},function(e){r.$apply(function(){r.locations[r.locations.indexOf(o)]=e,r.updateCurrentLocation(e),r.updateCurrentFolder(e)})},function(e,t){o.httpStatus=t,o.errorMessage=e,i(function(){r.updateCurrentLocation(o),r.updateCurrentFolder(o)})})):(r.updateCurrentLocation(o),r.updateCurrentFolder(o)),c.selectRecentLocation(o.url,o.ioType))},r.updateCurrentLocation=function(e){r.currentLocation=e,n.currentLocation=e,r.orderProp="Recent Documents"===e.name?null:"name"},r.updateCurrentFolder=function(e){r.currentFolder=e,r.currentFolder&&r.currentFolder.dirty&&r.refresh()},r.changeDir=function(e){function n(){a.stop("refresh-spinner"),r.currentFolder=e}r.resetUI(),a.spin("refresh-spinner"),e.dirty?(e.httpStatus=void 0,e.errorMessage=null,e.update(function(){r.$apply(function(){n()})},function(e,t,o){e.httpStatus=o,e.errorMessage=t,r.$apply(function(){n()})})):n()},r.folderUp=function(){r.currentFolder.parent&&(r.updateCurrentFolder(r.currentFolder.parent),r.resetUI())},r.refresh=function(){r.resetUI(),"Recent Documents"===r.currentLocation.name?(r.currentLocation.children=c.getRecentDocs(),r.currentFolder=r.currentFolder):(a.spin("refresh-spinner"),r.currentFolder.httpStatus=void 0,r.currentFolder.errorMessage=null,r.currentFolder.update(!0,function(){r.$evalAsync(function(){r.currentFolder=r.currentFolder,i(function(){a.stop("refresh-spinner")},1e3)})},function(e,t,o){a.stop("refresh-spinner"),e.httpStatus=o,e.errorMessage=t,r.$apply()}))},r.openFile=function(e){var t="/editor?uri="+encodeURIComponent(e.url)+"&ioType="+encodeURIComponent(e.ioType);e.sparqlEndpoint&&(t+="&sparqlEndpoint="+encodeURIComponent(e.sparqlEndpoint)),"save"===r.mode?t+="&saveDocument=true":e.isNew&&(t+="&newDocument=true"),o.url(t)},r.open=function(e){"file"===e.type?r.openFile(e):r.changeDir(e)},r.addLocation=function(e){for(var t=0;t<r.locations.length;t++)if(r.locations[t].url===e.url)return void(r.locations[t]=e);r.locations.push(e),c.addRecentLocation(e)},r.removeLocation=function(e){for(var t=0;t<r.locations.length;t++)if(r.locations[t].url===e.url)return r.locations.splice(t,1),e===r.currentLocation&&r.setCurrentLocation(r.locations[0]),void c.deleteRecentLocation(e.url,e.ioType)},r.addingLocation=!1,r.showNewLocationUi=function(){r.addingLocation=!0,r.newLocationUrl=""},r.addNewLocation=function(){var e,t;r.newLocationUrl&&r.newLocationUrl.length&&("http:"!==(e=RDFE.Utils.splitUrl(r.newLocationUrl)).protocol&&"https:"!==e.protocol?s.notify("error","Only HTTP and HTTPS protocols are supported"):r.newLocationIsSparql?((e=new RDFE.IO.Folder(r.newLocationUrl)).ioType="sparql",e.sparqlEndpoint=r.newLocationUrl,r.addLocation(e),r.updateCurrentLocation(e),r.currentFolder=e,r.addingLocation=!1):(a.spin("location-spinner"),c.getAuthInfo&&(t=function(e,t,o){c.getAuthInfo(e,!0).then(t,o)}),RDFE.IO.openUrl(r.newLocationUrl,{authFunction:t,checkForFiles:!0},function(e){r.$apply(function(){r.addingLocation=!1,r.addLocation(e),r.updateCurrentLocation(e),r.currentFolder=e}),a.stop("location-spinner")},function(e,t){s.notify("error",e),a.stop("location-spinner")})))},r.locations=[],r.getLocations(),r.getStorages(),r.$on("signIn",function(e,t){r.getStorages()}),r.addingGraph=!1,r.showNewGraphUi=function(){r.addingGraph=!0,r.newGraphUri=""},r.addNewGraph=function(){var e;r.newGraphUri&&r.newGraphUri.length&&((e=new RDFE.IO.File(r.newGraphUri)).parent=r.currentFolder,e.sparqlEndpoint=r.currentFolder.sparqlEndpoint,e.ioType="sparql",r.currentFolder.children.push(e),r.openFile(e))},r.addingFile=!1,r.newFileName="myDocument.ttl",r.showNewFileUi=function(){r.addingFile=!0,r.newFileName="myDocument.ttl"},r.addNewFile=function(){var e;r.newFileName&&r.newFileName.length&&(r.currentFolder.dirty=!0,e=r.currentFolder.url+r.newFileName,(e=new RDFE.IO.File(e)).isNew=!0,e.ioType=r.currentFolder.ioType,r.openFile(e))},r.resetUI=function(){r.addingFile=!1,r.addingGraph=!1,r.addingLocation=!1}}]);